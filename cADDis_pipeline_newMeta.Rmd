---
title: "cADDis Pipeline"
author: "Dain Brademan"
date: "2024-04-05"
output: html_document
---

This pipeline is specific to Gi-coupled receptors???

# Load Required Packages

```{r}
library(data.table)
library(readxl)
library(tidyr)
library(dplyr)
library(ggplot2)

drb_utils <- "https://raw.githubusercontent.com/HuttenhainLab/drb_utils/main/"
source(paste0(drb_utils,"data_management.R"))
source(paste0(drb_utils,"cADDis_pipeline_utils.R"))
```

# Set parameters for file parsing

```{r}

# Define the file paths & sheet names for three Excel Spreadsheets
  # Metadata, Baseline, Treatment

# Each file has a filepath, sheet name, and skipline property.
  # filepath: path to the file, absolute or relative
  # sheet: name of the Excel spreadsheet
  # skiplines: number of rows to skip before the desired data table

# Metadata File Information
metadata = list(
  filepath = "./example_data/040342024_Layout.xlsx",
  sheet = "Table_Meta",
  skiplines = 0
)

# Baseline File Information
baseline = list(
  filepath = "./example_data/04032024_baseline.xlsx",
  sheet = "Table All Cycles",
  skiplines = 9
)

# Treatment File Information
treatment = list(
  filepath = "./example_data/04032024_damgoDR.xlsx",
  sheet = "Table All Cycles",
  skiplines = 9
)
```

# Set parameters for experiment-specific comparisons

```{r}
# create subdirectories to store intermediate tables and figures
data.name <- "cADDis_Pipeline"
Create.Pipeline.Directories(data.name)

# Define experimental condition categories & comparison sets
  # cADDis-negative control - no fluorophore.
cADDis.control <- "NO cADDis"

# Correct all measurements using the cADDis.Control. Default is false
fluorophore.correction = FALSE

# Comparisons - Groups relevant ceiling curves & conditions together.
experiment.comparisons <- list()

###
# Repeat this chunk as many times as relevant to what's in your plate.
###
comparison <- list(
  label = "ISO Treatment",
  ceiling.condition = "ISO Alone",
  sample.conditions = c("ISO + D (0.0001)", "ISO + D (0.001)", "ISO + D (0.01)", "ISO + D (0.1)", "ISO + D (1)", "ISO + D (10)")
)

experiment.comparisons <- append(experiment.comparisons, list(comparison)) # stores the experimental comparison in a running list

###
# Repeat this chunk as many times as relevant to what's in your plate.
###
comparison <- list(
  label = "FSK Treatment",
  ceiling.condition = "FSK Alone",
  sample.conditions = c("FSK + D (0.0001)","FSK + D (0.001)","FSK + D (0.01)","FSK + D (0.1)","FSK + D (1)","FSK + D (10)")
)

experiment.comparisons <- append(experiment.comparisons, list(comparison))

```

# Package up everything into a nice data format for downstream operations

You shouldn't need to edit this chunk unless you're doing something more advanced

```{r}
# Package up all these parameters into one variable for easy access down the line
parameters <- list(
  # input files & manipulated data
  metadata = metadata,
  baseline = baseline,
  treatment = treatment,
  
  # experiment-specific parameters
  cADDis.control = cADDis.control,
  experiment.comparisons = experiment.comparisons
  
)

```

# Read in data using provided parameters

```{r}

metadata <- read_excel(parameters$metadata$filepath, 
                       sheet = parameters$metadata$sheet)

baseline <- read_excel(parameters$baseline$filepath, 
                       sheet = parameters$baseline$sheet, 
                       skip = parameters$baseline$skiplines)

treatment <- read_excel(parameters$treatment$filepath, 
                        sheet = parameters$treatment$sheet, 
                        skip = parameters$treatment$skiplines)

```

# Clean imported data tables

```{r}

# cADDis software exports well data in the format A01, A02, etc. 
# Example_Metadata is in the format A1, A2, etc. 
# Need to correct this to to make sure data tables merge correctly.
metadata <- Reformat.Metadata.Well.Position(metadata)

# Add Replicate column to metadata table if it doesn't exist
metadata <- Reformat.Metadata.Add.Replicates(metadata)

# Baseline and treatment tables are in wide-format.
# Does the following data manipulations: 
  # Remove unneccesary metadata  
  # Pivot table from wide to long format.
  # Join-in measurement times
  # Parse measurement times to from string to numeric
baseline <- Pivot.cADDIs.Data.Table(baseline)
treatment <- Pivot.cADDIs.Data.Table(treatment)

```

# Merge metadata table with treatment & baseline tables

```{r}

baseline <- merge(baseline, metadata, by = "Well", all = TRUE)
treatment <- merge(treatment, metadata, by = "Well", all = TRUE)

```

# Extract the no cADDis background from the baseline & treatment tables

```{r}
# Variable to store all analysis results
results <- list(
  baseline = list(),
  treatment = list()
)

# get mean & st.dev for the no cADDis background wells over time
# this will be subtracted from all other measurements
results$baseline$no.cADDis.background <- Extract.cADDis.Background.Signal(baseline, parameters$cADDis.control)
results$treatment$no.cADDis.background <- Extract.cADDis.Background.Signal(treatment, parameters$cADDis.control)

```

# Subtract the no-cADDis background from the baseline/treatment data tables.

Linearly shift all data with respect to the no-cADDis samples. This effectively zeroes all readings at all timepoints to the no-cADDis samples.

If conduct.correction == FALSE or no.cADDis.background == NULL, just return the raw readings.

```{r}

# Correct all readings. If this works, when we recalculate the no.cADDis background, the mean no-cADDis readings will be set to zero.
  results$baseline$corrected.table <- Background.Correct.Data.Table(baseline, 
                                                                    results$baseline$no.cADDis.background)

  results$treatment$corrected.table <- Background.Correct.Data.Table(treatment, 
                                                                     results$treatment$no.cADDis.background)

Save.Csv.With.Timestamp(results$baseline$corrected.table, "baseline_nocADDis_corrected.csv", paste(data.name, "data", sep = "_"))
Save.Csv.With.Timestamp(results$treatment$corrected.table, "treatment_nocADDis_corrected.csv", paste(data.name, "data", sep = "_"))

# Check to make sure background zeroed out correctly
background.test <- Extract.cADDis.Background.Signal(input.data.table = results$baseline$corrected.table, 
                                                    no.cADDis.condition = parameters$cADDis.control, 
                                                    target.column = "Corrected.Reading")

ggplot(background.test, aes(x = Measurement.Time, y = Reading.Mean)) +
  geom_line() +                                            
  geom_ribbon(aes(ymin = Reading.Mean - Reading.StDev,         
                  ymax = Reading.Mean + Reading.StDev),
              alpha = 0.3) +                                
  labs(title = "No-cADDis readings post-correction", x = "Measurement Time", y = "Mean Reading of No-cADDis Samples")          

# remove the temp variables
ggsave(paste(paste(data.name, "figures", sep = "_"), "QC_BackgroundCorrection_Validation.pdf", sep = "/"))

rm(background.test)
```

# Calculate ΔF/Fₒ ratios for all samples

```{r}

results$combined <- list(ΔF.Fₒ.Table = Calculate.Fluoresence.Ratios(results$treatment$corrected.table, results$baseline$corrected.table))

Save.Csv.With.Timestamp(results$combined$ΔF.Fₒ.Table, "combined_experiment_results.csv", paste(data.name, "data", sep = "_"))

```

# Visualize response curves 

```{r}

# calculate mean/standard deviation of all conditions across plate
results.combined.summary <- results$combined$ΔF.Fₒ.Table %>%
  group_by(Drug, Measurement.Time) %>%
  summarize(Mean.dF.Fo = mean(ΔF.Fₒ),
            StDev.dF.Fo = sd(ΔF.Fₒ))

# get max time of baseline (i.e. when treatment starts)
max.baseline.time <-  results$combined$ΔF.Fₒ.Table %>%
  filter(Type == "Baseline") %>%
  pull(Measurement.Time) %>%
  max()

lapply(parameters$experiment.comparisons, function(comparison) {
  
  samples <- as.data.table(results.combined.summary) %>%
    filter(Drug %in% comparison$ceiling.condition | Drug %in% comparison$sample.conditions)
  
  samples[, Drug := factor(Drug, levels = sort(unique(Drug), decreasing = TRUE))]
  
  # ggplot(samples, aes(x = Measurement.Time, y = Mean.dF.Fo, color = Drug)) +
  #   geom_line() + 
  #   geom_ribbon(aes(ymin = Mean.dF.Fo - StDev.dF.Fo,
  #                 ymax = Mean.dF.Fo + StDev.dF.Fo,
  #                 fill = Drug),
  #             alpha = 0.3) +
  #   geom_vline(xintercept = max.baseline.time, linetype = "dashed", color = "darkgray") +
  #   labs(title = paste0("DeltaF/Fo responses for ", comparison$label, " FSK samples"), x = "Measurement Time", y = "Delta F/Fo") +
  #   theme_bw()
  
  ggplot(samples, aes(x = Measurement.Time, y = Mean.dF.Fo, color = Drug)) +
    geom_point() + 
    geom_errorbar(aes(ymin = Mean.dF.Fo - StDev.dF.Fo,
                      ymax = Mean.dF.Fo + StDev.dF.Fo),
                  linewidth = 0.1,
                  width = 0.2) +
    geom_vline(xintercept = max.baseline.time, linetype = "dashed", color = "darkgray") +
    labs(title = paste0("DeltaF/Fo responses for ", comparison$label, " FSK samples"), x = "Measurement Time (min)", y = "Delta F/Fo") +
    scale_color_viridis_d(option = "turbo") +
    theme_bw() + 
    theme(aspect.ratio= 1 / 2)
  
  ggsave(paste(paste(data.name, "figures", sep = "_"), paste(comparison$label, "DeltaF_Fo_Curves.pdf", sep = "_"), sep = "/")) 
  
})
```

# Derive AUC 
